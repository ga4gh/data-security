<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>AAI FAQ | GA4GH Data Security</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="AAI FAQ">
<meta property="og:locale" content="en_US">
<meta name="description" content="AAI">
<meta property="og:description" content="AAI">
<link rel="canonical" href="/data-security/1.2-draft-faq-changes/aai-faq">
<meta property="og:url" content="/data-security/1.2-draft-faq-changes/aai-faq">
<meta property="og:site_name" content="GA4GH Data Security">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="AAI FAQ">
<script type="application/ld+json">
{"description":"AAI","url":"/data-security/1.2-draft-faq-changes/aai-faq","@type":"WebPage","headline":"AAI FAQ","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/data-security/1.2-draft-faq-changes/assets/main.css">
<link type="application/atom+xml" rel="alternate" href="/data-security/1.2-draft-faq-changes/feed.xml" title="GA4GH Data Security">
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/data-security/1.2-draft-faq-changes/">GA4GH Data Security</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/data-security/1.2-draft-faq-changes/aai-introduction">AAI Introduction</a><a class="page-link" href="/data-security/1.2-draft-faq-changes/aai-openid-connect-profile">AAI OIDC Profile</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">AAI FAQ</h1>
  </header>

  <div class="post-content">
    <p>A collection of questions (and hopefully useful answers).</p>

<hr style="border: 2px solid; margin: 2em auto;">

<h2 id="flows">Flows</h2>

<p>The following sequence diagrams are included to help explain the intended flows
documented in the accompanying specification.</p>

<h3 id="what-is-the-complete-end-to-end-flow-using-userinfo">What is the complete end to end flow using <code class="language-plaintext highlighter-rouge">/userinfo</code>?</h3>

<p>(last updated June 2022)</p>

<p>The flow as used by Elixir uses the initial <em>Passport-Scoped Access Token</em> as
a token handed to downstream resource servers. These servers can use this token, in conjunction
with a callback to the broker’s <em>Userinfo Endpoint</em>, to obtain the <em>Passport</em> content in
JSON format.</p>

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" preserveaspectratio="none" version="1.1" viewbox="0 0 1212 809" zoomandpan="magnify">
  <defs>
    <filter height="300%" id="f1gtzjzt8bbc5h" width="300%" x="-1" y="-1">
      <fegaussianblur result="blurOut" stddeviation="2.0"></fegaussianblur>
      <fecolormatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></fecolormatrix>
      <feoffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feoffset>
      <feblend in="SourceGraphic" in2="blurOut3" mode="normal"></feblend>
    </filter>
  </defs>
  <g>
    <rect fill="#EEEEEE" height="790.2813" style="stroke:#A80036;stroke-width:1.0;" width="198" x="11" y="6"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="83" x="68.5" y="18.0669">Researcher</text>
    <rect fill="#DDDDDD" height="790.2813" style="stroke:#A80036;stroke-width:1.0;" width="273" x="231" y="6"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="24" x="355.5" y="18.0669">AAI</text>
    <rect fill="#DDDDDD" height="790.2813" style="stroke:#A80036;stroke-width:1.0;" width="162" x="526" y="6"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="87" x="563.5" y="18.0669">Data Owner</text>
    <rect fill="#DDDDDD" height="790.2813" style="stroke:#A80036;stroke-width:1.0;" width="271" x="710" y="6"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="89" x="801" y="18.0669">Data Holder</text>
    <rect fill="#87CEFA" filter="url(#f1gtzjzt8bbc5h)" height="130.7969" style="stroke:#000000;stroke-width:2.0;" width="504" x="225" y="395.7578"></rect>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="56" x2="56" y1="108.4297" y2="802.2813"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="156" x2="156" y1="108.4297" y2="802.2813"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="287" x2="287" y1="108.4297" y2="802.2813"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="458" x2="458" y1="108.4297" y2="802.2813"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="607" x2="607" y1="108.4297" y2="802.2813"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="795" x2="795" y1="108.4297" y2="802.2813"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="932" x2="932" y1="108.4297" y2="802.2813"></line>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="77" x="15" y="105.1279">User Agent</text>
    <ellipse cx="56.5" cy="35.1328" fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"></ellipse>
    <path d="M56.5,43.1328 L56.5,70.1328 M43.5,51.1328 L69.5,51.1328 M56.5,70.1328 L43.5,85.1328 M56.5,70.1328 L69.5,85.1328 " fill="none" filter="url(#f1gtzjzt8bbc5h)" style="stroke:#A80036;stroke-width:2.0;"></path>
    <rect fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="53" x="128" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="39" x="135" y="93.1279">Client</text>
    <rect fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="60" x="255" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="46" x="262" y="93.1279">Broker</text>
    <rect fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="35" x="441" y="69.1328"></rect>
    <rect fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="35" x="437" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="21" x="444" y="93.1279">IdP</text>
    <rect fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="106" x="554" y="69.1328"></rect>
    <rect fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="106" x="550" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="92" x="557" y="93.1279">Visa Issuer(s)</text>
    <rect fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="734" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="105" x="741" y="93.1279">Clearing House</text>
    <rect fill="#FEFECE" filter="url(#f1gtzjzt8bbc5h)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="46" x="907" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="32" x="914" y="93.1279">Data</text>
    <rect fill="#EEEEEE" filter="url(#f1gtzjzt8bbc5h)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1205.5" x="0" y="138.9961"></rect>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1205.5" y1="138.9961" y2="138.9961"></line>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1205.5" y1="141.9961" y2="141.9961"></line>
    <rect fill="#EEEEEE" filter="url(#f1gtzjzt8bbc5h)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="50" x="577.75" y="128.4297"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="36" x="583.75" y="144.4966">OIDC</text>
    <rect fill="#FFFFFF" filter="url(#f1gtzjzt8bbc5h)" height="40.2656" style="stroke:#000000;stroke-width:2.0;" width="487" x="12" y="161.5625"></rect>
    <path d="M12,161.5625 L78,161.5625 L78,168.5625 L68,178.5625 L12,178.5625 L12,161.5625 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="21" x="25" y="175.6294">ref</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="469" x="23" y="194.6294">OIDC flow results in the client holding a *Passport-Scoped Access Token*.</text>
    <rect fill="#EEEEEE" filter="url(#f1gtzjzt8bbc5h)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1205.5" x="0" y="227.3945"></rect>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1205.5" y1="227.3945" y2="227.3945"></line>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1205.5" y1="230.3945" y2="230.3945"></line>
    <rect fill="#EEEEEE" filter="url(#f1gtzjzt8bbc5h)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="41" x="582.25" y="216.8281"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="27" x="588.25" y="232.895">Use</text>
    <polygon fill="#A80036" points="783.5,287.2266,793.5,291.2266,783.5,295.2266,787.5,291.2266" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="156.5" x2="789.5" y1="291.2266" y2="291.2266"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="129" x="163.5" y="286.1606">Client requests data</text>
    <path d="M800,254.9609 L800,309.9609 L1191,309.9609 L1191,264.9609 L1181,254.9609 L800,254.9609 " fill="#FBFB77" filter="url(#f1gtzjzt8bbc5h)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M1181,254.9609 L1181,264.9609 L1191,264.9609 L1181,254.9609 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="806" y="272.0278">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="362" x="814" y="287.1606">Authorization: Bearer &lt;Passport-Scoped Access Token&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="806" y="302.2935">}</text>
    <polygon fill="#A80036" points="298,356.625,288,360.625,298,364.625,294,360.625" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="292" x2="794.5" y1="360.625" y2="360.625"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="262" x="304" y="355.5591">Clearing house asks for passport content</text>
    <path d="M800,324.3594 L800,379.3594 L1191,379.3594 L1191,334.3594 L1181,324.3594 L800,324.3594 " fill="#FBFB77" filter="url(#f1gtzjzt8bbc5h)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M1181,324.3594 L1181,334.3594 L1191,334.3594 L1181,324.3594 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="806" y="341.4263">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="362" x="814" y="356.5591">Authorization: Bearer &lt;Passport-Scoped Access Token&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="806" y="371.6919">}</text>
    <path d="M225,395.7578 L640,395.7578 L640,402.7578 L630,412.7578 L225,412.7578 L225,395.7578 " fill="#00BFFF" style="stroke:#000000;stroke-width:1.0;"></path>
    <rect fill="none" height="130.7969" style="stroke:#000000;stroke-width:2.0;" width="504" x="225" y="395.7578"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="370" x="240" y="408.8247">Informative Only (not defined in the specification)</text>
    <polygon fill="#A80036" points="595,430.0234,605,434.0234,595,438.0234,599,434.0234" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="287" x2="601" y1="434.0234" y2="434.0234"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="180" x="294" y="428.9575">Fetch signed visa(s) for user</text>
    <polygon fill="#A80036" points="298,486.8555,288,490.8555,298,494.8555,294,490.8555" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="292" x2="606" y1="490.8555" y2="490.8555"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="187" x="304" y="485.7896">Return signed visa(s) for user</text>
    <path d="M612,447.0234 L612,517.0234 L710,517.0234 L710,457.0234 L700,447.0234 L612,447.0234 " fill="#FBFB77" filter="url(#f1gtzjzt8bbc5h)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M700,447.0234 L700,457.0234 L710,457.0234 L700,447.0234 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="5" x="618" y="464.0903">[</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="69" x="626" y="479.2231">"&lt;visa1&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="65" x="626" y="494.356">"&lt;visa2&gt;"</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="5" x="618" y="509.4888">]</text>
    <polygon fill="#A80036" points="783.5,616.2188,793.5,620.2188,783.5,624.2188,787.5,620.2188" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="287" x2="789.5" y1="620.2188" y2="620.2188"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="276" x="294" y="615.1528">UserInfo Endpoint returns passport content</text>
    <path d="M800,538.5547 L800,684.5547 L1040,684.5547 L1040,548.5547 L1030,538.5547 L800,538.5547 " fill="#FBFB77" filter="url(#f1gtzjzt8bbc5h)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M1030,538.5547 L1030,548.5547 L1040,548.5547 L1030,538.5547 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="806" y="555.6216">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="211" x="814" y="570.7544">"iss": "https://&lt;issuer-website&gt;/",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="183" x="814" y="585.8872">"sub": "&lt;subject-identifier&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="148" x="814" y="601.02">"ga4gh_passport_v1": [</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="69" x="822" y="616.1528">"&lt;visa1&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="69" x="822" y="631.2856">"&lt;visa2&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="12" x="818" y="646.4185">...</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="5" x="814" y="661.5513">]</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="806" y="676.6841">}</text>
    <path d="M635,698.75 L635,753.75 L1088,753.75 L1088,708.75 L1078,698.75 L635,698.75 " fill="#FFCCCB" filter="url(#f1gtzjzt8bbc5h)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M1078,698.75 L1078,708.75 L1088,708.75 L1078,698.75 " fill="#FFCCCB" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="432" x="641" y="715.8169">Decision is made to release data using information contained in the</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="425" x="641" y="730.9497">passport - and this decision is coordinated with the data system to</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="215" x="641" y="746.0825">facilitate that actual data release.</text>
    <polygon fill="#A80036" points="167.5,780.2813,157.5,784.2813,167.5,788.2813,163.5,784.2813" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="161.5" x2="794.5" y1="784.2813" y2="784.2813"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="121" x="173.5" y="779.2153">Client is given data</text>
    <!--MD5=[d3a97a2a63a59cbaf46a7c5248f6687f]
@startuml
skinparamlocked svgDimensionStyle false


hide footbox
skinparam BoxPadding 10
skinparam ParticipantPadding 20

box "Researcher"  #eee
actor       "User Agent"                as user
participant Client                      as client
end box

box "AAI"
participant Broker                      as broker
collections "IdP"                       as idps
end box

box "Data Owner"
collections "Visa Issuer(s)"            as issuers
end box

box "Data Holder"
participant "Clearing House"            as clearing
participant "Data"                      as data
end box

==OIDC==

ref over user, client, broker, idps
OIDC flow results in the client holding a *Passport-Scoped Access Token*.
end ref

==Use==

client -> clearing : Client requests data
note right
{
  Authorization: Bearer <Passport-Scoped Access Token>
}
end note

clearing -> broker : Clearing house asks for passport content
note right
{
  Authorization: Bearer <Passport-Scoped Access Token>
}
end note

group#DeepSkyBlue #LightSkyBlue Informative Only (not defined in the specification)
broker -> issuers : Fetch signed visa(s) for user
broker <- issuers : Return signed visa(s) for user
note right
[
  "<visa1>",
  "<visa2>"
]
end note
end

clearing <- broker : UserInfo Endpoint returns passport content
note right
{
  "iss": "https://<issuer-website>/",
  "sub": "<subject-identifier>",
  "ga4gh_passport_v1": [
    "<visa1>",
    "<visa2>",
   ...
  ]
}
end note


note over clearing, data  #FFCCCB
Decision is made to release data using information contained in the
passport - and this decision is coordinated with the data system to
facilitate that actual data release.
end note

client <- clearing : Client is given data



@enduml

PlantUML version 1.2021.10(Mon Aug 30 13:43:48 GMT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
-->
  </g>
</svg>

<hr style="width: 10em; margin: 2em auto;">

<h3 id="what-is-the-complete-end-to-end-flow-using-token-exchange">What is the complete end to end flow using token exchange?</h3>

<p>(last updated June 2022)</p>

<p>The exchange flow does not ever distribute the initial <em>Passport-Scoped Access Token</em> beyond
the client application. A token exchange operation is executed by the client, in
exchange for a <em>Passport</em> JWT that may be used downstream to access resources. In this example flow, the
<em>Passport</em> is included as authorisation in the POST to a DRS server. The token
exchange has also specified a known resource server website that will limit the audience
of the <em>Passport</em>.</p>

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" preserveaspectratio="none" version="1.1" viewbox="0 0 1120 1215" zoomandpan="magnify">
  <defs>
    <filter height="300%" id="f17i7x55hce2eq" width="300%" x="-1" y="-1">
      <fegaussianblur result="blurOut" stddeviation="2.0"></fegaussianblur>
      <fecolormatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></fecolormatrix>
      <feoffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feoffset>
      <feblend in="SourceGraphic" in2="blurOut3" mode="normal"></feblend>
    </filter>
  </defs>
  <g>
    <rect fill="#EEEEEE" height="1196.6016" style="stroke:#A80036;stroke-width:1.0;" width="198" x="11" y="6"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="83" x="68.5" y="18.0669">Researcher</text>
    <rect fill="#DDDDDD" height="1196.6016" style="stroke:#A80036;stroke-width:1.0;" width="232.5" x="271.5" y="6"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="24" x="375.75" y="18.0669">AAI</text>
    <rect fill="#DDDDDD" height="1196.6016" style="stroke:#A80036;stroke-width:1.0;" width="162" x="526" y="6"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="87" x="563.5" y="18.0669">Data Owner</text>
    <rect fill="#DDDDDD" height="1196.6016" style="stroke:#A80036;stroke-width:1.0;" width="271" x="710" y="6"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="89" x="801" y="18.0669">Data Holder</text>
    <rect fill="#87CEFA" filter="url(#f17i7x55hce2eq)" height="130.7969" style="stroke:#000000;stroke-width:2.0;" width="463.5" x="265.5" y="386.8906"></rect>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="56" x2="56" y1="108.4297" y2="1208.6016"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="156" x2="156" y1="108.4297" y2="1208.6016"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="327.5" x2="327.5" y1="108.4297" y2="1208.6016"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="458" x2="458" y1="108.4297" y2="1208.6016"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="607" x2="607" y1="108.4297" y2="1208.6016"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="795" x2="795" y1="108.4297" y2="1208.6016"></line>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="932" x2="932" y1="108.4297" y2="1208.6016"></line>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="77" x="15" y="105.1279">User Agent</text>
    <ellipse cx="56.5" cy="35.1328" fill="#FEFECE" filter="url(#f17i7x55hce2eq)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"></ellipse>
    <path d="M56.5,43.1328 L56.5,70.1328 M43.5,51.1328 L69.5,51.1328 M56.5,70.1328 L43.5,85.1328 M56.5,70.1328 L69.5,85.1328 " fill="none" filter="url(#f17i7x55hce2eq)" style="stroke:#A80036;stroke-width:2.0;"></path>
    <rect fill="#FEFECE" filter="url(#f17i7x55hce2eq)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="53" x="128" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="39" x="135" y="93.1279">Client</text>
    <rect fill="#FEFECE" filter="url(#f17i7x55hce2eq)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="60" x="295.5" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="46" x="302.5" y="93.1279">Broker</text>
    <rect fill="#FEFECE" filter="url(#f17i7x55hce2eq)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="35" x="441" y="69.1328"></rect>
    <rect fill="#FEFECE" filter="url(#f17i7x55hce2eq)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="35" x="437" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="21" x="444" y="93.1279">IdP</text>
    <rect fill="#FEFECE" filter="url(#f17i7x55hce2eq)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="106" x="554" y="69.1328"></rect>
    <rect fill="#FEFECE" filter="url(#f17i7x55hce2eq)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="106" x="550" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="92" x="557" y="93.1279">Visa Issuer(s)</text>
    <rect fill="#FEFECE" filter="url(#f17i7x55hce2eq)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="734" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="105" x="741" y="93.1279">Clearing House</text>
    <rect fill="#FEFECE" filter="url(#f17i7x55hce2eq)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="46" x="907" y="73.1328"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="32" x="914" y="93.1279">Data</text>
    <rect fill="#EEEEEE" filter="url(#f17i7x55hce2eq)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1113" x="0" y="138.9961"></rect>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113" y1="138.9961" y2="138.9961"></line>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113" y1="141.9961" y2="141.9961"></line>
    <rect fill="#EEEEEE" filter="url(#f17i7x55hce2eq)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="50" x="531.5" y="128.4297"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="36" x="537.5" y="144.4966">OIDC</text>
    <rect fill="#FFFFFF" filter="url(#f17i7x55hce2eq)" height="40.2656" style="stroke:#000000;stroke-width:2.0;" width="487" x="12" y="161.5625"></rect>
    <path d="M12,161.5625 L78,161.5625 L78,168.5625 L68,178.5625 L12,178.5625 L12,161.5625 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="21" x="25" y="175.6294">ref</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="469" x="23" y="194.6294">OIDC flow results in the client holding a *Passport-Scoped Access Token*.</text>
    <rect fill="#EEEEEE" filter="url(#f17i7x55hce2eq)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1113" x="0" y="227.3945"></rect>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113" y1="227.3945" y2="227.3945"></line>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113" y1="230.3945" y2="230.3945"></line>
    <rect fill="#EEEEEE" filter="url(#f17i7x55hce2eq)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="85" x="514" y="216.8281"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="71" x="520" y="232.895">Exchange</text>
    <polygon fill="#A80036" points="315.5,317.4922,325.5,321.4922,315.5,325.4922,319.5,321.4922" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="156.5" x2="321.5" y1="321.4922" y2="321.4922"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="104" x="163.5" y="316.4263">Token exchange</text>
    <path d="M332,254.9609 L332,369.9609 L799,369.9609 L799,264.9609 L789,254.9609 L332,254.9609 " fill="#FBFB77" filter="url(#f17i7x55hce2eq)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M789,254.9609 L789,264.9609 L799,264.9609 L789,254.9609 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="317" x="338" y="272.0278">Content-Type: application/x-www-form-urlencoded</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="0" x="342" y="287.1606"></text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="397" x="338" y="302.2935">grant_type=urn:ietf:params:oauth:grant-type:token-exchange</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="446" x="338" y="317.4263">requested_token_type=urn:ga4gh:params:oauth:token-type:passport</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="322" x="338" y="332.5591">subject_token=&lt;Passport-Scoped Access Token&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="438" x="338" y="347.6919">subject_token_type=urn:ietf:params:oauth:token-type:access_token</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="319" x="338" y="362.8247">audience=https://&lt;drs-resource-server-website&gt;/</text>
    <path d="M265.5,386.8906 L680.5,386.8906 L680.5,393.8906 L670.5,403.8906 L265.5,403.8906 L265.5,386.8906 " fill="#00BFFF" style="stroke:#000000;stroke-width:1.0;"></path>
    <rect fill="none" height="130.7969" style="stroke:#000000;stroke-width:2.0;" width="463.5" x="265.5" y="386.8906"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="370" x="280.5" y="399.9575">Informative Only (not defined in the specification)</text>
    <polygon fill="#A80036" points="595,421.1563,605,425.1563,595,429.1563,599,425.1563" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="327.5" x2="601" y1="425.1563" y2="425.1563"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="180" x="334.5" y="420.0903">Fetch signed visa(s) for user</text>
    <polygon fill="#A80036" points="338.5,477.9883,328.5,481.9883,338.5,485.9883,334.5,481.9883" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="332.5" x2="606" y1="481.9883" y2="481.9883"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="187" x="344.5" y="476.9224">Return signed visa(s) for user</text>
    <path d="M612,438.1563 L612,508.1563 L710,508.1563 L710,448.1563 L700,438.1563 L612,438.1563 " fill="#FBFB77" filter="url(#f17i7x55hce2eq)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M700,438.1563 L700,448.1563 L710,448.1563 L700,438.1563 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="5" x="618" y="455.2231">[</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="69" x="626" y="470.356">"&lt;visa1&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="65" x="626" y="485.4888">"&lt;visa2&gt;"</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="5" x="618" y="500.6216">]</text>
    <polygon fill="#A80036" points="167.5,758.6797,157.5,762.6797,167.5,766.6797,163.5,762.6797" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="161.5" x2="326.5" y1="762.6797" y2="762.6797"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="147" x="173.5" y="757.6138">Token exchange return</text>
    <path d="M332,529.6875 L332,977.6875 L878,977.6875 L878,539.6875 L868,529.6875 L332,529.6875 " fill="#FBFB77" filter="url(#f17i7x55hce2eq)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M868,529.6875 L868,539.6875 L878,539.6875 L868,529.6875 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="338" y="546.7544">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="357" x="346" y="561.8872">"access_token": "&lt;passport token (base64 encoded)&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="443" x="346" y="577.02">"issued_token_type": "urn:ga4gh:params:oauth:token-type:passport",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="146" x="346" y="592.1528">"token_type": "Bearer",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="98" x="346" y="607.2856">"expires_in": 60</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="338" y="622.4185">}</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="0" x="342" y="637.5513"></text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="525" x="338" y="652.6841">▼ passport token content decoded from base64 (generally opaque to the client) ▼</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="0" x="342" y="667.8169"></text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="338" y="682.9497">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="207" x="346" y="698.0825">"typ": "vnd.ga4gh.passport+jwt",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="92" x="346" y="713.2153">"alg": "RS256",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="150" x="346" y="728.3481">"kid": "&lt;key-identifier&gt;"</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="16" x="338" y="743.481">} .</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="338" y="758.6138">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="211" x="346" y="773.7466">"iss": "https://&lt;issuer-website&gt;/",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="183" x="346" y="788.8794">"sub": "&lt;subject-identifier&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="47" x="346" y="804.0122">"aud": [</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="260" x="354" y="819.145">"https://&lt;drs-resource-server-website&gt;/"</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="9" x="346" y="834.2778">],</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="195" x="346" y="849.4106">"iat": &lt;seconds-since-epoch&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="202" x="346" y="864.5435">"exp": &lt;seconds-since-epoch&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="161" x="346" y="879.6763">"jti": "&lt;token-identifier&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="148" x="346" y="894.8091">"ga4gh_passport_v1": [</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="69" x="354" y="909.9419">"&lt;visa1&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="69" x="354" y="925.0747">"&lt;visa2&gt;",</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="12" x="354" y="940.2075">...</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="5" x="346" y="955.3403">]</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="102" x="338" y="970.4731">} . &lt;signature&gt;</text>
    <rect fill="#EEEEEE" filter="url(#f17i7x55hce2eq)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1113" x="0" y="1008.1055"></rect>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113" y1="1008.1055" y2="1008.1055"></line>
    <line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113" y1="1011.1055" y2="1011.1055"></line>
    <rect fill="#EEEEEE" filter="url(#f17i7x55hce2eq)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="41" x="536" y="997.5391"></rect>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthadjust="spacing" textlength="27" x="542" y="1013.606">Use</text>
    <polygon fill="#A80036" points="783.5,1067.9375,793.5,1071.9375,783.5,1075.9375,787.5,1071.9375" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="156.5" x2="789.5" y1="1071.9375" y2="1071.9375"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="129" x="163.5" y="1066.8716">Client requests data</text>
    <path d="M800,1035.6719 L800,1090.6719 L1064,1090.6719 L1064,1045.6719 L1054,1035.6719 L800,1035.6719 " fill="#FBFB77" filter="url(#f17i7x55hce2eq)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M1054,1035.6719 L1054,1045.6719 L1064,1045.6719 L1054,1035.6719 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="806" y="1052.7388">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="243" x="806" y="1067.8716">REPLACE WITH CORRECT DRS DETAILS</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="8" x="806" y="1083.0044">}</text>
    <path d="M618,1105.0703 L618,1160.0703 L1104,1160.0703 L1104,1115.0703 L1094,1105.0703 L618,1105.0703 " fill="#FFCCCB" filter="url(#f17i7x55hce2eq)" style="stroke:#A80036;stroke-width:1.0;"></path>
    <path d="M1094,1105.0703 L1094,1115.0703 L1104,1115.0703 L1094,1105.0703 " fill="#FFCCCB" style="stroke:#A80036;stroke-width:1.0;"></path>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="432" x="624" y="1122.1372">Decision is made to release data using information contained in the</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="465" x="624" y="1137.27">passport token - and this decision is coordinated with the data system to</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="215" x="624" y="1152.4028">facilitate that actual data release.</text>
    <polygon fill="#A80036" points="167.5,1186.6016,157.5,1190.6016,167.5,1194.6016,163.5,1190.6016" style="stroke:#A80036;stroke-width:1.0;"></polygon>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="161.5" x2="794.5" y1="1190.6016" y2="1190.6016"></line>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="121" x="173.5" y="1185.5356">Client is given data</text>
    <!--MD5=[c8b18dde05954587646ccce105548600]
@startuml
skinparamlocked svgDimensionStyle false


hide footbox
skinparam BoxPadding 10
skinparam ParticipantPadding 20

box "Researcher"  #eee
actor       "User Agent"                as user
participant Client                      as client
end box

box "AAI"
participant Broker                      as broker
collections "IdP"                       as idps
end box

box "Data Owner"
collections "Visa Issuer(s)"            as issuers
end box

box "Data Holder"
participant "Clearing House"            as clearing
participant "Data"                      as data
end box

==OIDC==

ref over user, client, broker, idps
OIDC flow results in the client holding a *Passport-Scoped Access Token*.
end ref

==Exchange==

client -> broker : Token exchange
note right
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:token-exchange
requested_token_type=urn:ga4gh:params:oauth:token-type:passport
subject_token=<Passport-Scoped Access Token>
subject_token_type=urn:ietf:params:oauth:token-type:access_token
audience=https://<drs-resource-server-website>/
end note

group#DeepSkyBlue #LightSkyBlue Informative Only (not defined in the specification)
broker -> issuers : Fetch signed visa(s) for user
broker <- issuers : Return signed visa(s) for user
note right
[
  "<visa1>",
  "<visa2>"
]
end note
end

client <- broker : Token exchange return
note right
{
  "access_token": "<passport token (base64 encoded)>",
  "issued_token_type": "urn:ga4gh:params:oauth:token-type:passport",
  "token_type": "Bearer",
  "expires_in": 60
}

▼ passport token content decoded from base64 (generally opaque to the client) ▼

{
  "typ": "vnd.ga4gh.passport+jwt",
  "alg": "RS256",
  "kid": "<key-identifier>"
} .
{
  "iss": "https://<issuer-website>/",
  "sub": "<subject-identifier>",
  "aud": [
    "https://<drs-resource-server-website>/"
  ],
  "iat": <seconds-since-epoch>,
  "exp": <seconds-since-epoch>,
  "jti": "<token-identifier>",
  "ga4gh_passport_v1": [
    "<visa1>",
    "<visa2>",
    ...
  ]
} . <signature>
end note

==Use==

client -> clearing : Client requests data
note right
{
REPLACE WITH CORRECT DRS DETAILS
}
end note

note over clearing, data  #FFCCCB
Decision is made to release data using information contained in the
passport token - and this decision is coordinated with the data system to
facilitate that actual data release.
end note

client <- clearing : Client is given data


@enduml

PlantUML version 1.2021.10(Mon Aug 30 13:43:48 GMT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
-->
  </g>
</svg>

<hr style="width: 10em; margin: 2em auto;">

<h3 id="can-a-jwt-alone-be-used-for-authentication-even-if-the-spec-mostly-talks-about-oidc-flow">Can a JWT alone be used for authentication even if the spec mostly talks about OIDC Flow?</h3>

<p>(last updated ??? 2020)</p>

<p>Yes. This specification allows for groups to organize themselves in many ways.</p>

<p>A trusted group of Brokers and Passport Clearinghouses are permitted to
format <code class="language-plaintext highlighter-rouge">/userinfo</code> output as a JWT and use that as a means of how their
services communicate. They can also take <code class="language-plaintext highlighter-rouge">/userinfo</code> JSON output and
format it through some other means into a JWT. Proper due-diligence and
handling of tokens must be followed.</p>

<p>This specification does not prohibit services from using JWTs as authentication
outside of an OIDC flow.</p>

<p>An example: Two different stacks of software all have a similar user-base and
often use the same shared data resource – a biobank, for instance. The User
authenticates with Biobank Broker on Software stack S1 and gets <code class="language-plaintext highlighter-rouge">/userinfo</code> output
as a JWT. The JWT includes GA4GH Passport Visas for a Dataset that the Broker holds
permissions for. S1 might not hold the data, S2 might hold the data. The User may
be allowed to bring that JWT to Software Stack S2 and get data authorized by the
claim in the JWT and held by S2, provided that S2 can trust S1 as a valid and
trustworthy client.</p>

<p>This enables two or more software stacks to work together more fluidly than having
the same user authenticate twice across two stacks to access the same data. There
is an assumption that these two software stacks have agreements and risk assessment
in place in order to make this a secure method of authentication and that the User
is aware that they are exchanging information with another stack without
explicit OIDC-style consent.</p>

<p><img src="./AAI/GA4GH_JWT-only_flow.png" alt="JWT-Only Flow between trusted stacks"></p>

<hr style="border: 2px solid; margin: 2em auto;">

<h2 id="threat-analysis">Threat Analysis</h2>

<h3 id="what-is-the-danger-of-using-a-fully-scoped-or-audience-less-token-in-a-multi-node-workflow">What is the danger of using a fully scoped (or audience-less) token in a multi node workflow</h3>

<p>Unless down-scoped by the initial OIDC flow - the <em>Passport Scoped Access Token</em> is
a token that can unlock all data that the user is entitled to. Furthermore, it is
unscoped in audience - with no indications of 
the Clearinghouse (or downstream services) it is intended for.</p>

<p>The result of this is that if passed to a bad actor (a Clearinghouse that has been
compromised for example) - the bad actor can use the token
for sideways movement amongst the other nodes.</p>

<p>Insert diagram.</p>

<p>The addition of audiences to the token, or down-scoping of permissions - possible via token exchange - limits
the scope of damage if the token ends up with a bad actor.</p>

<hr style="border: 2px solid; margin: 2em auto;">

<h2 id="client-software">Client Software</h2>

<h3 id="use-of-ga4gh-passportvisas-in-single-page-apps-spas">Use of GA4GH passport/visas in Single Page Apps (SPAs)</h3>

<p>A Single Page App (SPA) such as a React/VueJs website
contains all the source of the application in public - and hence cannot
possess a ‘secret’ in an OIDC flow (the ‘secret’ is used to prove the identity of the
client software).</p>

<p>The registration of a callback URL - in conjunction with the cryptographic techniques
of PKCE - does allow a SPA to safely participate in an OIDC authorisation flow - though
it makes weak guarantees regarding the client identity.</p>

<p>However, when it comes to token exchange - there is no equivalent of a registered
callback URL - that can even weakly assert client identity.</p>

<p>It is impossible for the SPA to prove that is correct/desired piece of code
executing the exchange - and not some other system that has somehow captured a
<em>Passport-Scoped Access Token</em> from the browser and is making an exchange.</p>

<p>For these reasons, it is recommended at this point that SPAs are not used for
applications where the SPA is solely responsible for the dissemination of
genomic data.</p>

<p>It is possible for a SPA to predominantly execute in browser - but to still use
a (small) backend set of services to execute any OIDC flows and token exchanges. These
backend service <em>can</em> retain a secret and hence can prove client identity.</p>

<p>Insert diagram.</p>

<hr style="border: 2px solid; margin: 2em auto;">

<h2 id="legacy">Legacy</h2>

<h3 id="can-the-output-of-userinfo-be-used-as-a-jwt-for-authentication">Can the output of <code class="language-plaintext highlighter-rouge">/userinfo</code> be used as a JWT for Authentication?</h3>

<p>(consider removing as now dealt with more in spec)</p>

<p>The spec says that <code class="language-plaintext highlighter-rouge">/userinfo</code> may be formatted as a JWT. A Clearinghouse that
sends an access token to a <code class="language-plaintext highlighter-rouge">/userinfo</code> endpoint might get either JSON or a
formatted and signed JWT from a broker. The JWT can be used downstream as
an authentication mechanism if downstream services like Clearinghouses
support it and know what to do with it.</p>

<p>It is probable that a special token endpoint will exist in a future
version of this profile that should prevent the <code class="language-plaintext highlighter-rouge">/userinfo</code> endpoint
from being overloaded.</p>


  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/data-security/1.2-draft-faq-changes/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">GA4GH Data Security</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">GA4GH Data Security</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>AAI</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
